{% extends "base.html" %}

{% block title %}Chess{% endblock %}

{% block extra_head %}
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"
  />
  <style>
    #board {
      width: 400px;
      max-width: 100%;
      margin: 0 auto;
    }
    .chess-container {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    #status {
      font-weight: 600;
      color: #444;
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 0.5rem;
      display: inline-block;
      min-width: 200px;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="text-center mb-5">
        <h1 class="display-6 fw-bold">Interactive Chess</h1>
        <p class="text-muted small">Classic game of strategy and skill</p>
      </div>

      <div class="row align-items-center g-5">
        <div class="col-md-7">
          <div class="chess-container shadow-lg">
            <div id="board"></div>
          </div>
        </div>
        <div class="col-md-5">
          <div class="card border-0 shadow-sm p-4 h-100">
            <div class="card-body d-flex flex-column justify-content-center">
              <h3 class="h5 fw-bold mb-4 d-flex align-items-center">
                <i class="bi bi-info-circle text-primary me-2"></i>
                Game Info
              </h3>
              
              <div class="mb-4">
                <label class="text-muted small fw-bold mb-2 d-block">GAME STATUS</label>
                <div id="status">Loading...</div>
              </div>

              <div class="d-grid gap-2">
                <button onclick="location.reload()" class="btn btn-outline-primary btn-lg">
                  <i class="bi bi-arrow-counterclockwise me-2"></i>Reset Board
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-light text-muted border">
                  <i class="bi bi-house me-2"></i>Exit Game
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
  <script>
    var game = new Chess();
    var statusEl = document.getElementById('status');

    function onDragStart(source, piece, position, orientation) {
      if (game.game_over()) return false;

      if (
        (game.turn() === 'w' && piece.search(/^b/) !== -1) ||
        (game.turn() === 'b' && piece.search(/^w/) !== -1)
      ) {
        return false;
      }
    }

    function onDrop(source, target) {
      var move = game.move({
        from: source,
        to: target,
        promotion: 'q',
      });

      if (move === null) return 'snapback';

      updateStatus();
    }

    function onSnapEnd() {
      board.position(game.fen());
    }

    function updateStatus() {
      var status = '';
      var moveColor = 'White';

      if (game.turn() === 'b') {
        moveColor = 'Black';
      }

      if (game.in_checkmate()) {
        status = 'Game over, ' + moveColor + ' is in checkmate.';
      } else if (game.in_draw()) {
        status = 'Game over, drawn position.';
      } else {
        status = moveColor + ' to move';

        if (game.in_check()) {
          status += ', ' + moveColor + ' is in check';
        }
      }

      statusEl.textContent = status;
    }

    var board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDragStart: onDragStart,
      onDrop: onDrop,
      onSnapEnd: onSnapEnd,
    });

    updateStatus();
  </script>
{% endblock %}
