{% extends "base.html" %}

{% block title %}Read Books{% endblock %}

{% block extra_head %}
  <style>
    .viewer-card {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    #viewerContainer {
      height: 75vh;
      overflow: auto;
      background: #525659;
      padding: 20px 0;
    }
    #pdfCanvas {
      display: block;
      margin: 0 auto;
      background: white;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }
    .pdf-toolbar {
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      padding: 0.75rem 1.5rem;
    }
    .page-info {
      background: white;
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      border: 1px solid #dee2e6;
      font-weight: 600;
      font-size: 0.875rem;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-xl-10">
      <div class="d-flex align-items-center justify-content-between mb-4 mt-2">
        <div class="d-flex align-items-center">
          <div class="bg-primary text-white rounded p-3 me-3">
            <i class="bi bi-book-half h4 mb-0"></i>
          </div>
          <div>
            <h1 class="h3 fw-bold mb-0">PDF Document Reader</h1>
            <p class="text-muted small mb-0">Reading: {{ pdf_file.split('/')[-1] }}</p>
          </div>
        </div>
        <a href="{{ url_for('index') }}" class="btn btn-light border px-4">
          <i class="bi bi-x-lg"></i>
        </a>
      </div>

      <div class="viewer-card">
        <div class="pdf-toolbar d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <div class="btn-group shadow-sm">
              <button id="prevPage" class="btn btn-white border">
                <i class="bi bi-chevron-left"></i>
              </button>
              <button id="nextPage" class="btn btn-white border">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
            <div class="page-info shadow-sm">
              Page <span id="pageNum">1</span> of <span id="pageCount">?</span>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <div class="btn-group shadow-sm">
              <button id="zoomOut" class="btn btn-white border">
                <i class="bi bi-dash-lg"></i>
              </button>
              <button id="zoomIn" class="btn btn-white border">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
            <div class="page-info shadow-sm" style="min-width: 80px; text-align: center;">
              <span id="zoomLevel">100%</span>
            </div>
          </div>
        </div>

        <div id="viewerContainer">
          <canvas id="pdfCanvas"></canvas>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script>
    const url = "{{ url_for('static', filename=pdf_file) }}";

    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js';

    let pdfDoc = null,
      pageNum = 1,
      pageRendering = false,
      pageNumPending = null,
      scale = 1.0,
      canvas = document.getElementById('pdfCanvas'),
      ctx = canvas.getContext('2d');

    function renderPage(num) {
      pageRendering = true;
      pdfDoc.getPage(num).then(function (page) {
        const viewport = page.getViewport({ scale: scale });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderContext = {
          canvasContext: ctx,
          viewport: viewport,
        };
        const renderTask = page.render(renderContext);

        renderTask.promise.then(function () {
          pageRendering = false;
          document.getElementById('pageNum').textContent = num;
          document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';

          if (pageNumPending !== null) {
            renderPage(pageNumPending);
            pageNumPending = null;
          }
        });
      });
    }

    function queueRenderPage(num) {
      if (pageRendering) {
        pageNumPending = num;
      } else {
        renderPage(num);
      }
    }

    function onPrevPage() {
      if (pageNum <= 1) {
        return;
      }
      pageNum--;
      queueRenderPage(pageNum);
    }

    function onNextPage() {
      if (pageNum >= pdfDoc.numPages) {
        return;
      }
      pageNum++;
      queueRenderPage(pageNum);
    }

    function onZoomIn() {
      scale = Math.min(scale + 0.1, 3.0);
      queueRenderPage(pageNum);
    }

    function onZoomOut() {
      scale = Math.max(scale - 0.1, 0.3);
      queueRenderPage(pageNum);
    }

    document.getElementById('prevPage').addEventListener('click', onPrevPage);
    document.getElementById('nextPage').addEventListener('click', onNextPage);
    document.getElementById('zoomIn').addEventListener('click', onZoomIn);
    document.getElementById('zoomOut').addEventListener('click', onZoomOut);

    pdfjsLib
      .getDocument(url)
      .promise.then(function (pdfDoc_) {
        pdfDoc = pdfDoc_;
        document.getElementById('pageCount').textContent = pdfDoc.numPages;
        renderPage(pageNum);
      })
      .catch(function (error) {
        console.error('Error loading PDF:', error);
      });
  </script>
{% endblock %}
